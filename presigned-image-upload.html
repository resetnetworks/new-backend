<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>S3 Presigned Image Upload</title>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      padding: 24px;
      max-width: 600px;
      margin: auto;
    }
    input, textarea, button {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
    }
    progress {
      width: 100%;
      margin-top: 12px;
    }
    img {
      margin-top: 16px;
      max-width: 100%;
      border-radius: 8px;
      display: none;
    }
    pre {
      background: #f4f4f4;
      padding: 12px;
      margin-top: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <h2>üñºÔ∏è S3 Presigned Image Upload (Upload Only)</h2>

  <label>Presigned Upload URL</label>
  <textarea id="uploadUrl" rows="4" placeholder="Paste presigned URL here"></textarea>

  <label>Expected S3 Key (for reference)</label>
  <input id="key" placeholder="covers/uuid.webp" />

  <label>Select Image File</label>
  <input
    type="file"
    id="fileInput"
    accept="image/jpeg,image/png,image/webp"
  />

  <button id="uploadBtn">Upload Image to S3</button>

  <progress id="progress" value="0" max="100"></progress>

  <img id="preview" />

  <pre id="output"></pre>

  <script>
    const output = document.getElementById("output");
    const progress = document.getElementById("progress");
    const preview = document.getElementById("preview");

    document.getElementById("uploadBtn").onclick = async () => {
      const uploadUrl = document.getElementById("uploadUrl").value.trim();
      const file = document.getElementById("fileInput").files[0];

      if (!uploadUrl) {
        alert("Paste presigned upload URL");
        return;
      }

      if (!file) {
        alert("Select an image to upload");
        return;
      }

      if (!file.type.startsWith("image/")) {
        alert("Invalid image type");
        return;
      }

      try {
        output.textContent = "‚¨ÜÔ∏è Uploading image to S3...";
        progress.value = 0;

        await uploadWithProgress(uploadUrl, file);

        output.textContent += "\n‚úÖ Upload successful!";

        // Local preview (optional)
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      } catch (err) {
        console.error(err);
        output.textContent += `\n‚ùå Upload failed: ${err.message}`;
      }
    };

    function uploadWithProgress(uploadUrl, file) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();

        xhr.open("PUT", uploadUrl, true);

        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            progress.value = Math.round((event.loaded / event.total) * 100);
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            resolve();
          } else {
            reject(new Error(`HTTP ${xhr.status}`));
          }
        };

        xhr.onerror = () => reject(new Error("Network error"));

        xhr.send(file);
      });
    }
  </script>

</body>
</html>
